<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/iron-fit-behavior/iron-fit-behavior.html">
<link rel="import" href="../../bower_components/iron-a11y-announcer/iron-a11y-announcer.html">
<link rel="import" href="../../bower_components/iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="../../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">

<!--
    @author Robin Duda
    Polymer element for use as a login box.
 -->

<dom-module id="game-login">
    <link rel="import" href="../../style/theme.css" type="css">
    <link rel="import" href="../../style/style.css" type="css">
    <template>
        <style>
            :host {
                display: inline-block;
            }
            .title {
                text-align: center;
                padding-top: 16px;
            }
            .container {
                width: 525px;
            }
            .register {
                margin-top: 32px;
            }
            .fit-login {
                width: 100%;
                min-width: 0;
                border-radius: 0;
                margin: 0;
            }

        </style>

        <div class="container center-box" id="container">
            <paper-material elevation="3">
                <div class="title">
                    <h4>{{title}}</h4>
                </div>

                <paper-input value="{{username}}" id="username" label="Username" on-keydown="submit"
                             autofocus></paper-input>
                <paper-input value="{{password}}" id="password" label="Password" on-keydown="submit"
                             type="password"></paper-input>

                <div hidden$="{{hideregisterform}}">
                    <paper-input value="{{password-repeat}}" label="Password (repeat)" type="password"
                                 on-keydown="submit" id="password-repeat"></paper-input>
                    <paper-input value="{{email}}" label="Email (optional)" on-keydown="submit"></paper-input>

                    <paper-button class="register flex" on-tap="showLoginForm">Back</paper-button>
                    <paper-button raised class="primary flex" on-tap="register">Register</paper-button>
                </div>

                <div hidden$="{{hideloginform}}">
                    <paper-button class="register flex" on-tap="showRegisterForm">Register</paper-button>
                    <paper-button raised class="primary flex" on-tap="authenticate">Authenticate</paper-button>
                </div>
            </paper-material>

            <paper-toast class="toast-login fit-login" id="toast-login"
                         text="{{toastText}}" opened></paper-toast>
            </div>

    </template>
    <script>
        Polymer({
            is: 'game-login',
            ready: function () {
                this.showLoginForm();
            },

            authenticate: function (e) {
                var self = this;
                this.$['toast-login'].open();

                authentication.login({
                    accepted: function (data) {
                        self.resetForm();
                        application.authenticated(data);
                    },
                    unauthorized: function (data) {
                        self.$['toast-login'].open();
                        self.password = "";
                        self.$['password'].focus();
                    },
                    missing: function(data) {
                        self.$['toast-login'].open();
                        self.showRegisterForm();
                        self.$['password-repeat'].focus();
                    },
                    error: function (data) {
                        self.set('toastText', e.message);
                    },
                    failed: function () {
                        application.error('Failed to establish a connection to the authentication server.')
                    }
                }, this.username, this.password);
            },

            register: function (e) {
                var self = this;
                this.$['toast-login'].open()

                authentication.register({
                    accepted: function (data) {
                        self.resetForm();
                        application.authenticated(data);
                    },
                    bad: function (data) {
                        self.$['toast-login'].open();
                    },
                    conflict: function (data) {
                        self.$['toast-login'].open();
                        self.$['username'].focus();
                    },
                    failed: function () {
                        application.error("Failed to establish a connection to the authentication server.")
                    }
                }, this.username, this.password, this.email);
            },
            resetForm: function () {
                this.password = "";
                this["password-repeat"] = "";
                this.email = "";
                this.showLoginForm();
            },

            showLoginForm: function () {
                this.title = "Login";
                this.hideregisterform = true;
                this.hideloginform = false;
                this.$['username'].focus();
            },

            showRegisterForm: function () {
                this.title = "Register";
                this.hideregisterform = false;
                this.hideloginform = true;
                this.$['username'].focus();
            },

            submit: function (e) {
                if (e.keyCode == 13) {
                    if (!this.hideregisterform)
                        this.register();

                    if (!this.hideloginform)
                        this.authenticate();
                }
            }
        });


    </script>
</dom-module>